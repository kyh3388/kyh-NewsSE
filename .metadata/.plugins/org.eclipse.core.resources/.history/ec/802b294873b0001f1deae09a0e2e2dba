import React, { useState, useEffect } from 'react';
import { Link, useLocation, useNavigate } from 'react-router-dom';
import axios from 'axios';
import './MainPage.css';

/*************** ì‹œê°„ í‘œì‹œë¥¼ ìœ„í•œ í•¨ìˆ˜ ***************/
// í˜„ì¬ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ 1ë¶„ì „, 1ì‹œê°„ì „ ì´ë ‡ê²Œ í‘œì‹œ
// í•˜ë£¨ê°€ ë„˜ì–´ê°€ë©´ 11.12 ì´ë ‡ê²Œ ë‹¹ì¼ ë‚ ì§œë¡œ í‘œì‹œ

function formatTimeDifference(pubDate) {
	// ì—°ì‚° í•  ìˆ˜ ìˆê²Œ Date ê°ì²´ë¡œ ë³€í™˜
    const publishedDate = new Date(pubDate);
    // í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
    const now = new Date();
    
    // ë‚ ì§œ ë¹„êµë¥¼ ìœ„í•´ ì—°/ì›”/ì¼ì„ ê°ê° ì¶”ì¶œ
    const publishedYear = publishedDate.getFullYear(); // ì…ë ¥ë°›ì€ ë‚ ì§œì˜ ì—°ë„
    const publishedMonth = publishedDate.getMonth();  // ì…ë ¥ë°›ì€ ë‚ ì§œì˜ ì›” (0ë¶€í„° ì‹œì‘)
    const publishedDay = publishedDate.getDate();     // ì…ë ¥ë°›ì€ ë‚ ì§œì˜ ì¼

    // í˜„ì¬ ë‚ ì§œì˜ ì—°ë„, ì›”, ì¼ì„ ê°ê° ì¶”ì¶œ
    const currentYear = now.getFullYear(); // í˜„ì¬ ë‚ ì§œì˜ ì—°ë„
    const currentMonth = now.getMonth();  // í˜„ì¬ ë‚ ì§œì˜ ì›” (0ë¶€í„° ì‹œì‘)
    const currentDay = now.getDate();     // í˜„ì¬ ë‚ ì§œì˜ ì¼

    // ì˜¤ëŠ˜ ë‚ ì§œì¸ì§€ í™•ì¸
    if (
        publishedYear === currentYear &&
        publishedMonth === currentMonth &&
        publishedDay === currentDay
    ) {
        // ì˜¤ëŠ˜ ë‚ ì§œë¼ë©´ í˜„ì¬ ì‹œê°„ê³¼ì˜ ì°¨ì´ë¥¼ ê³„ì‚°
        const diffInMs = now - publishedDate; // í˜„ì¬ ì‹œê°„ - ìš”ì²­ë°›ì€ ì‹œê°„ (ë°€ë¦¬ì´ˆ ë‹¨ìœ„)
        const diffInMinutes = Math.floor(diffInMs / 60000); // ë°€ë¦¬ì´ˆë¥¼ ë¶„ ë‹¨ìœ„ë¡œ ë³€í™˜ (1ë¶„ = 60000ms)

        // ì‹œê°„ ì°¨ì´ì— ë”°ë¼ í‘œì‹œ
        if (diffInMinutes < 1) // 1ë¶„ ë¯¸ë§Œ
        	return 'ë°©ê¸ˆ ì „'; 
        if (diffInMinutes < 60) // 1ì‹œê°„ ë¯¸ë§Œ
        	return `${diffInMinutes}ë¶„ ì „`; 

        const diffInHours = Math.floor(diffInMinutes / 60); // ì‹œê°„ì„ ê³„ì‚°
        return `${diffInHours}ì‹œê°„ ì „`; // 1ì‹œê°„ ì´ìƒì¸ ê²½ìš°
        
    } else {
        // ì˜¤ëŠ˜ ë‚ ì§œê°€ ì•„ë‹ˆë¼ë©´ 'ì›”.ì¼' í˜•ì‹ìœ¼ë¡œ ë‚ ì§œ í‘œì‹œ
        // `publishedDate.getMonth()`ëŠ” 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ 1ì„ ë”í•´ì¤Œ
        return `${publishedDate.getMonth() + 1}.${publishedDate.getDate()}`;
    }
}
/********************************************/



/********** API ì‘ë‹µ ë°ì´í„° HTML í‘œì‹œ ë¬¸ì œ í•´ê²° **********/

// ì¶”ê°€ëœ í•¨ìˆ˜: API ì‘ë‹µ ë°ì´í„°ì—ì„œ HTML ì—”í„°í‹° ë””ì½”ë”©(<,&,"" ì´ëŸ° íŠ¹ìˆ˜ê¸°í˜¸ë¥¼ ê·¸ëŒ€ë¡œ í‘œì‹œ)
function decodeHtmlEntities(str) {
    const parser = new DOMParser();
    return parser.parseFromString(str, 'text/html').documentElement.textContent;
}

// ì¶”ê°€ëœ í•¨ìˆ˜: API ì‘ë‹µ ë°ì´í„°ì—ì„œ HTML íƒœê·¸ ì œê±°
function removeHtmlTags(str) {
    return str.replace(/<[^>]+>/g, '');
}
/********************************************/




function MainPage() {
	
	const [news, setNews] = useState([]);
	const [page, setPage] = useState(1); // í˜ì´ì§€ ìƒíƒœ ì¶”ê°€
	const displayCount = 36; // í•œ ë²ˆì— ê°€ì ¸ì˜¬ ê¸°ì‚¬ ìˆ˜
	const [searchQuery, setSearchQuery] = useState('');
	const [searchHistory, setSearchHistory] = useState([]); // ê²€ìƒ‰ ê¸°ë¡ ê´€ë¦¬
	const [isSearchFocused, setIsSearchFocused] = useState(false); // ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤ ìƒíƒœ ì¶”ê°€
	const location = useLocation();
	const navigate = useNavigate();
	
	// 1. ì´ˆê¸° í™”ë©´ ë° ìƒˆë¡œ ê³ ì¹¨
    useEffect(() => {
		const params = new URLSearchParams(location.search); // URLì˜ ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì„ íŒŒì‹±
		const query = params.get('query');
		
		// 'query' íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ 'ê¸°ì‚¬' ì‚¬ìš©
		if (!query) {
            fetchNews(1, 'ê¸°ì‚¬'); // queryê°€ ì—†ìœ¼ë©´ 'ê¸°ì‚¬'ë¡œ ìš”ì²­
        } else {
            setSearchQuery(query); // ê²€ìƒ‰ì°½ ì—…ë°ì´íŠ¸
            fetchNews(1, query); // query ê°’ìœ¼ë¡œ ë‰´ìŠ¤ ë°ì´í„° ìš”ì²­
        }
    }, [location.search]);  // location.searchê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì‹¤í–‰
	

	// 2. ë‰´ìŠ¤ ë°ì´í„° ìš”ì²­
	const fetchNews = (currentPage, query) => { // í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸ì™€ queryë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ì•„ì„œ ë‰´ìŠ¤ ë°ì´í„° ìš”ì²­
		
		const start = (currentPage - 1) * displayCount + 1; // ì‹œì‘ ì¸ë±ìŠ¤ ê³„ì‚°('ê¸°ì‚¬ ë”ë³´ê¸°')
		
		// ê²€ìƒ‰ì–´(query)ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ê²€ìƒ‰ì–´ë¥¼ 'ê¸°ì‚¬'ë¡œ ì„¤ì •
		const searchTerm = query && query.trim() !== '' ? query : 'ê¸°ì‚¬';
	
		axios
			.get(`http://localhost:8080/searchNews?query=${searchTerm}&display=36&start=${start}`)
			.then((response) => {
				// API ì‘ë‹µ í™•ì¸(itemsì— ì–´ë–¤ í•­ëª©ë“¤ì´ ìˆëŠ”ì§€ í™•ì¸)
				// console.log('API ì‘ë‹µ ë°ì´í„°:', response.data);
				
				// ì‘ë‹µ ë°ì´í„°ì˜ pubDateë¥¼ ì²˜ë¦¬í•˜ì—¬ ìƒˆë¡œìš´ ë°°ì—´ ìƒì„±
				const processedNews = response.data.items.map((item) => ({
                	...item,
                	
                	// ì œëª©,ë‚´ìš©ì—ì„œ HTML ì—”í„°í‹° ë””ì½”ë”© ë° íƒœê·¸ ì œê±°
                    title: decodeHtmlEntities(item.title),
                    description: decodeHtmlEntities(item.description),
                	
                	// ë‚ ì§œ í‘œì‹œ ë°©ì‹ ë³€ê²½
                	formattedPubDate: formatTimeDifference(item.pubDate), // pubDate í¬ë§· ì ìš©
            	}));

                // ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•© ë° ì¤‘ë³µ ì œê±°
            setNews((prevNews) => {
				if (currentPage === 1) {
       				return processedNews; // ì²« í˜ì´ì§€ì—ì„œëŠ” ê¸°ì¡´ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”
    			}
                const combinedNews = [...prevNews, ...processedNews];
                
                // ì‹œê°„ìˆœ ì •ë ¬
                return combinedNews.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
            });
        })
            .catch(error => {
                console.error('Error fetching news:', error);
            });
    };
    
	
	
	// ì´ˆê¸° ë¡œë”© ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê²€ìƒ‰ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    useEffect(() => {
        const storedHistory = JSON.parse(localStorage.getItem('searchHistory')) || [];
        setSearchHistory(storedHistory);
    }, []);
	
    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    const handleSearch = () => {
        if (searchQuery.trim() === '') {
            navigate('/');
            return;
        }

        // ê²€ìƒ‰ ê¸°ë¡ ì¤‘ë³µ í™•ì¸ í›„ ì¶”ê°€
        if (!searchHistory.includes(searchQuery)) {
            const updatedHistory = [searchQuery, ...searchHistory.slice(0, 9)]; // ìµœëŒ€ 10ê°œ ìœ ì§€
            setSearchHistory(updatedHistory); // ìƒíƒœ ì—…ë°ì´íŠ¸
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥
            localStorage.setItem('searchHistory', JSON.stringify(updatedHistory));
        }
		// ê²€ìƒ‰ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
        navigate(`?query=${encodeURIComponent(searchQuery.trim())}`);
    };
    
    // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
	//const handleFocus = () => {
	//	setIsSearchFocused(true); // í¬ì»¤ìŠ¤ê°€ ìˆìœ¼ë©´ ê²€ìƒ‰ ê¸°ë¡ í‘œì‹œ
	//};

	// í¬ì»¤ìŠ¤ í•´ì œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
	//const handleBlur = () => {
	//	setTimeout(() => setIsSearchFocused(false), 1000); // í¬ì»¤ìŠ¤ í•´ì œ í›„ ê²€ìƒ‰ ê¸°ë¡ ìˆ¨ê¸°ê¸° (200ms ë”œë ˆì´)
	//};
    
    
    
    // "ê¸°ì‚¬ ë” ë³´ê¸°" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í˜ì´ì§€ ì¦ê°€
	const handleLoadMore = () => {
		const nextPage = page + 1; // ë‹¤ìŒ í˜ì´ì§€
        setPage(nextPage); // í˜ì´ì§€ ìƒíƒœ ì—…ë°ì´íŠ¸
        fetchNews(nextPage, searchQuery); // í˜„ì¬ ê²€ìƒ‰ ì¤‘ì¸ ì¿¼ë¦¬ë¡œ ë°ì´í„° ìš”ì²­
	};
    
    
    
	
/*************** ë©”ì¸ í˜ì´ì§€ ì¶œë ¥ ***************/
// ë°°ì¹˜(ì œëª©,ì‹œê°„,ì›ë¬¸ë§í¬)
// "ê¸°ì‚¬ ë”ë³´ê¸°" ë²„íŠ¼

	return (
		<div className="MainPage"> 
			<div className="mainpage-head">
			
				<h1 className="header-title">
					<a href='/'
						style={{
								textDecoration: 'none',
								color: 'black'
							  }}
					>News SE</a>
				</h1>
				
				
	            <div style={{ position: 'relative' }}>
	                <div className="search-box">
	                	
	                    <input
	                        type="text"
	                        className="search-text"
	                        placeholder="ë‰´ìŠ¤ ê²€ìƒ‰"
	                        value={searchQuery} // ì…ë ¥ê°’ì„ ìƒíƒœë¡œ ìœ ì§€
     		   				onChange={(e) => setSearchQuery(e.target.value)} // ìƒíƒœ ì—…ë°ì´íŠ¸
	                        
	                        onFocus={() => setIsSearchFocused(true)} // í¬ì»¤ìŠ¤ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
    						onBlur={() => setTimeout(() => setIsSearchFocused(false), 200)} // í¬ì»¤ìŠ¤ í•´ì œ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
	                    />
	                    <button
	                        type="button"
	                        className="search-button"
	                        onClick={handleSearch} // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ handleSearch í˜¸ì¶œ
	                    />
	                    
	                </div>
				
					{/* ê²€ìƒ‰ ê¸°ë¡ í‘œì‹œ */}
					{isSearchFocused && (
						<div className="search-history">
						    <ul>
						        {searchHistory.map((historyItem, index) => (
						            <li
						            	key={index}
						            	className="history-item"
						            	onClick={() => {
											setSearchQuery(historyItem); // í´ë¦­ëœ ê²€ìƒ‰ì–´ë¥¼ ê²€ìƒ‰ì°½ì— ì…ë ¥
						                    navigate(`?query=${encodeURIComponent(historyItem)}`); // ê²€ìƒ‰ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
						                    fetchNews(1, historyItem); // ì²« í˜ì´ì§€ ë°ì´í„° ìš”ì²­
						                }}
						                style={{ cursor: 'pointer' }} // í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ìŠ¤íƒ€ì¼ ì¶”ê°€		            
						            >
						            
						                <span>{historyItem}</span>
						                <button
						                    className="delete-btn"
						                    onClick={(e) => {
						                        e.stopPropagation(); // í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
						                        const updatedHistory = searchHistory.filter((_, i) => i !== index);
						                        setSearchHistory(updatedHistory);
						                        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
						                        localStorage.setItem('searchHistory', JSON.stringify(updatedHistory));
						                    }}
						                >
						                    X
						                </button>
						            </li>
						        ))}
						    </ul>
						</div>
					)}
				</div>
			</div>
			
			<div className="mainpage-body">
				{/* ê¸°ì‚¬ë¥¼ 6ê°œì”© ë‚˜ëˆ  ë¸”ë¡ìœ¼ë¡œ ê·¸ë£¹í™” */}
			    {Array.from({ length: Math.ceil(news.length / 6) }).map((_, blockIndex) => (
			        <div className="block" key={blockIndex}>
			            <div className="grid-container">
			                {news.slice(blockIndex * 6, blockIndex * 6 + 6).map((item, index) => (
			                    <div key={index} className="grid-item">	
									<Link
									    to="/extra-page"
									    state={{
									        title: item.title,
									        pubDate: item.pubDate,
									        description: item.description,
									        link: item.link,
									    }}
									    style={{
											textDecoration: 'none',
											color: 'black',
											fontWeight: 'bold',
										}}
									    
									>
									    <h2>{item.title}</h2>
									</Link>
									
									{/* ë‚ ì§œì™€ ë²„íŠ¼ì„ í•œ ì¤„ì— ì •ë ¬ */}
			    					<div className="grid-item-info">
					                        <p>{item.formattedPubDate}</p>
					                        <a
					                        	href={item.link}
					                        	target="_blank"
					                        	rel="noopener noreferrer"
					                        	className="original-link-button"
					                        >
					                        	ë§í¬<i>ğŸ”—</i>
					                        </a>
					                    </div>
					               </div>
				                ))}
							</div>
						</div>
					))}
				</div>
			
			<div className="mainpage-foot">
				<button className="news-plus" onClick={handleLoadMore}>ê¸°ì‚¬ ë”ë³´ê¸°â–¼</button>
			</div>
		</div>
	);

// target="blank" : ìƒˆ íƒ­ì—ì„œ í™”ë©´ ì—´ê¸°
// rel="noopener noreferrer" : ë³´ì•ˆê³¼ í”„ë¼ì´ë²„ì‹œ ë³´í˜¸ë¥¼ ìœ„í•´ ìƒˆ íƒ­ì—ì„œ ì—´ë¦° í˜ì´ì§€ê°€ ì›ë˜ í˜ì´ì§€ì— ì ‘ê·¼í•˜ì§€ ëª»í•˜ê²Œ í•˜ê³ , ì›ë˜ í˜ì´ì§€ì˜ ì°¸ì¡° ì •ë³´ë„ ì „ë‹¬ë˜ì§€ ì•Šë„ë¡ í•œë‹¤
/********************************************/
	
}

export default MainPage;
















